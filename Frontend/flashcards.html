<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Flashcards</title>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: "Segoe UI", sans-serif;
}

body { background: #f4f6fb; }

/* ===== SIDEBAR ===== */
.sidebar {
  position: fixed;
  top: 0;
  left: 0;
  width: 240px;
  height: 100vh;
  background: linear-gradient(180deg, #5b6cff, #7a5cff);
  padding: 20px;
  color: white;
}

.sidebar a {
  display: block;
  color: white;
  text-decoration: none;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 10px;
}

.sidebar a:hover { background: rgba(255,255,255,0.2); }

/* ===== MAIN ===== */
.main {
  margin-left: 240px;
  padding: 40px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

h2 { margin-bottom: 20px; }

/* ===== FLASHCARD ===== */
.card-container { perspective: 1000px; }

.flashcard {
  width: 380px;
  height: 220px;
  position: relative;
  transform-style: preserve-3d;
  transition: transform 0.6s, opacity 0.2s;
  cursor: pointer;
}

.flashcard.flipped { transform: rotateY(180deg); }

.flashcard.fade {
  opacity: 0;
  transform: scale(0.96);
}

.card-face {
  position: absolute;
  width: 100%;
  height: 100%;
  backface-visibility: hidden;
  background: white;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.12);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 25px;
  text-align: center;
  font-size: 18px;
  font-weight: 600;
}

.card-back {
  transform: rotateY(180deg);
  background: #eef2ff;
  font-weight: normal;
}

/* ===== CONTROLS ===== */
.controls {
  margin-top: 30px;
  display: flex;
  align-items: center;
  gap: 20px;
}

.arrow {
  font-size: 24px;
  background: #4f46e5;
  color: white;
  border: none;
  border-radius: 50%;
  width: 48px;
  height: 48px;
  cursor: pointer;
}

.arrow:hover { background: #4338ca; }
.arrow:disabled { background: #a5b4fc; cursor: not-allowed; }

.progress { font-size: 14px; color: #555; }

/* ===== DIFFICULTY ===== */
.difficulty {
  margin-top: 20px;
  display: flex;
  gap: 12px;
}

.diff-btn {
  padding: 10px 18px;
  border: none;
  border-radius: 20px;
  color: white;
  cursor: pointer;
}

.easy { background: #22c55e; }
.medium { background: #f59e0b; }
.hard { background: #ef4444; }

.loading {
  margin-top: 14px;
  font-size: 14px;
  color: #4f46e5;
  display: none;
}
</style>
</head>

<body>

<!-- ===== PROJECT GUARD ===== -->
<script>
const projectId = localStorage.getItem("currentProjectId");
if (!projectId) {
  alert("No project selected. Redirecting to Home.");
  window.location.href = "home.html";
}
</script>

<div class="sidebar">
  <a href="home.html"><h2>Learn Flow</h2></a>
  <a href="index.html">Dashboard</a>
  <a href="upload.html">Upload Notes</a>
  <a href="flashcards.html">Flashcards</a>
  <a href="quiz.html">Quiz</a>
  <a href="tasks.html">Tasks</a>
</div>

<div class="main">
  <h2>ðŸ§  Flashcards</h2>

  <div class="card-container">
    <div class="flashcard" id="flashcard" onclick="flipCard()">
      <div class="card-face" id="question"></div>
      <div class="card-face card-back" id="answer"></div>
    </div>
  </div>

  <div class="difficulty">
    <button class="diff-btn easy" onclick="addTask('Easy')">Easy</button>
    <button class="diff-btn medium" onclick="addTask('Medium')">Medium</button>
    <button class="diff-btn hard" onclick="addTask('Hard')">Hard</button>
  </div>

  <div class="controls">
    <button class="arrow" onclick="prevCard()">â¬…</button>
    <div class="progress" id="progress"></div>
    <button class="arrow" onclick="nextCard()">âž¡</button>
    <button class="arrow" onclick="loadMore()">âž•</button>
  </div>

  <div class="loading" id="loading">Generating more flashcardsâ€¦</div>
</div>

<script>
/* ===============================
   LOAD PROJECT FLASHCARDS
=============================== */
let allFlashcards = JSON.parse(localStorage.getItem("flashcards")) || [];

let flashcards = allFlashcards
  .filter(f => f.projectId === projectId)
  .map(f => ({ q: f.question, a: f.answer }));

const fullText = localStorage.getItem("fullText_" + projectId) || "";

if (!flashcards.length) {
  flashcards = [{ q: "No flashcards yet", a: "Upload notes first." }];
}

let current = 0;

const card = document.getElementById("flashcard");
const question = document.getElementById("question");
const answer = document.getElementById("answer");
const progress = document.getElementById("progress");
const loadingText = document.getElementById("loading");

/* ===============================
   CARD LOGIC
=============================== */
function updateCard() {
  card.classList.add("fade");
  setTimeout(() => {
    question.innerText = flashcards[current].q;
    answer.innerText = flashcards[current].a;
    progress.innerText = `${current + 1} / ${flashcards.length}`;
    card.classList.remove("flipped", "fade");
  }, 120);
}

function flipCard() { card.classList.toggle("flipped"); }
function nextCard() { if (current < flashcards.length - 1) { current++; updateCard(); } }
function prevCard() { if (current > 0) { current--; updateCard(); } }

/* ===============================
   ADD TASK (PROJECT-SAFE)
=============================== */
function addTask(level) {
  let tasks = JSON.parse(localStorage.getItem("tasks")) || [];
  const c = flashcards[current];

  const exists = tasks.some(
    t => t.question === c.q && t.difficulty === level && t.projectId === projectId
  );

  if (!exists) {
    tasks.push({
      id: Date.now(),
      projectId,
      question: c.q,
      answer: c.a,
      difficulty: level,
      status: "pending"
    });
    localStorage.setItem("tasks", JSON.stringify(tasks));
  }

  nextCard();
}

/* ===============================
   LOAD MORE FLASHCARDS
=============================== */
async function loadMore() {
  loadingText.style.display = "block";

  try {
    const res = await fetch("http://localhost:3000/more-flashcards", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        text: fullText,
        existingFlashcards: flashcards.map(c => ({
          question: c.q,
          answer: c.a
        }))
      })
    });

    const data = await res.json();

    const newOnes = data.flashcards.map(fc => ({
      question: fc.question,
      answer: fc.answer,
      projectId
    }));

    allFlashcards = allFlashcards.concat(newOnes);
    localStorage.setItem("flashcards", JSON.stringify(allFlashcards));

    flashcards = flashcards.concat(
      newOnes.map(f => ({ q: f.question, a: f.answer }))
    );

    updateCard();
  } catch {
    alert("Failed to generate flashcards.");
  } finally {
    loadingText.style.display = "none";
  }
}

updateCard();
</script>

</body>
</html>
